<%
  var topics = JSON.parse(response);
  if (topics.status === 'success'){
    var len = topics.data.length;
    var title = ": Topics List";
%>

<% include ../partials/top %>
        <div class="container-fluid">
          <% include ../partials/belowtop %>
        <div class="row">
          <div class="col-sm-3 panel panel-default content-panel" id="topiclist-content-panel">

  <script>

  $(document).ready(function () {



    var len_topic_list = <%- len %>;
    var bjjtech_pagetitle = '<%- bjjtech.general.title %>';

  <%
    var api_url = process.env.BJJT_API_ROOT_URL + "/api/";
    var root_url = process.env.BJJT_WEB_ROOT_URL + "/";
  %>

  //
    $(document).on('click', '.get_techs_topic', function () {
      // Hide the nudge
      $("#nudge_topic").hide();
      // $("#detail-content-panel").hide();
      $("#detail-content-panel").removeClass('open');

      var topic_id = $(this).attr('data-id');
      var tag = $(this).attr('data-tag');

      $.ajax({
          url: "<%-api_url %>"+"tech/tag/"+tag+"/"+topic_id,
          success: function(result) {
            // $("#techlist-content-panel").show();
            $('#techs').empty();
            $('#num_techs').empty();
            var techs = result;
            if (techs.status === 'success'){
               $('#techlist-content-panel').addClass('open');
              var len = techs.data.length;
              var video = "";
              for(i = 0; i < len; i++){
                if (i == 0){
                  $('#num_techs').append(len+"&nbsp;"+techs.data[i].tag_name+"&nbsp;");
                  document.title = bjjtech_pagetitle+ ": Topic: "+ techs.data[i].tag_name;
                }
                if (techs.data[i].videoid){
                   video = '<i class="fa fa-video-camera"></i>&nbsp;';
                } else {
                   video = "&emsp;";
                }
                $('#techs').append("<a href='#' class='list-group-item get_tech_detail' id='"+ techs.data[i].index+"' data-listindex='"+i+"' data-id='"+techs.data[i].index+"'><h5 class='list-group-item-heading'>"+video+techs.data[i].name+"</h5></a>");
              }
              if (len > 0){
                $("#nudge_tech").show();
              }
            }
          }
      });
      return false;
  });
  $(document).on('click', '#moredetail', function () {
    var id = $(this).attr('data-id');
    window.location = "<%-root_url%>tech/"+id;
  });

  $(document).on('click', '.get_tech_detail', function () {
    var id = $(this).attr('data-id');

    $.ajax({
        url: "<%-api_url %>"+"tech/brief/"+id,
        success: function(result) {
          var tech = result,
          video = "";
          if (tech.status === 'success'){
            $('#detail_h').empty();
            $('#details').empty();
            $("#nudge_tech").hide();
            // $("#detail-content-panel").show();
            $('#detail-content-panel').addClass('open');
            // $("#nudge_detail").show();
            $('#detail_h').append(tech.data.name );
            // Swap \n with <br>
            if (tech.data.details){
               var details = cleanDetailText(tech.data.details);

               details = fixQuotes(details);
               tech.data.name = fixQuotes(tech.data.name);
               if (tech.data.videoid){
                  video = '<button id="moredetail" data-id="initiallyundefined" name="moredetail" class="btn btn-outline-primary bjjt_button "><i class="fa fa-video-camera"></i>&nbsp;Click for detail&nbsp;<i class="fa fa-expand" aria-hidden="true"></i></button>';
               } else {
                  video = '<button id="moredetail" data-id="initiallyundefined" name="moredetail" class="btn btn-outline-primary bjjt_button ">Click for detail&nbsp;<i class="fa fa-expand" aria-hidden="true"></i></button>';
               }
               $('#moredetail').replaceWith( video);

              document.title = bjjtech_pagetitle+ ": "+ tech.data.name;

            } else {
              var details = "Sorry, homie, I haven't written this yet.";
            }
            $('#moredetail').attr('data-id', tech.data.index);
            $('#details').append("<h4>Set Up</h4><p>"+ tech.data.setup+ "</p><h4>Details</h4><p>"+details +"</p>");
          }
        }
    });
    return false;
  });


});
  </script>
<%- "<h3>"+len+"&nbsp;Jits Topics&nbsp;<span id='nudge_topic' class='valign center pulsor nudge'>Click a topic.</span></h3>" %>
      <div class="list-group">
    <%
      for(i = 0; i < len; i++){ %>
        <a href="#" class="list-group-item get_techs_topic" id="<%= topics.data[i].index%>" data-listindex="<%=i%>" data-id="<%= topics.data[i].index%>" data-tag="<%=topics.data[i].tag%>"><h4 class="list-group-item-heading"><%= topics.data[i].name%></h4></a>
        <%
      }
    } else { %>
      <%- "<h4 class='list-group-item-heading'>No topics (try a search)</h4>" %>
    <%
    } %>
        </div>

      </div>
      <div class="col-sm-3 panel panel-default content-panel content-panel-slideout" id="techlist-content-panel">
         <h3><span id="num_techs"></span>Techniques<span id='nudge_tech' class='valign center pulsor nudge' style="display: none">Click a technique.</span></h3>
        <div class="list-group">
           <div id="techs"></div>
       </div>
    </div>
    <div class="col-sm-6 panel panel-default content-panel content-panel-slideout" id="detail-content-panel">
        <div class="container-fluid">
            <h3 id="detail_h"></h3>
            <div class="col-md-6 bjjt_button_parent">
                <button id="moredetail" data-id="initiallyundefined" name="moredetail" class="btn btn-outline-primary bjjt_button ">Click for more detail.&nbsp;<i class="fa fa-expand" aria-hidden="true"></i></button>
            </div>
            <div id="details"></div>
        </div>
    </div>
</div> <!-- row !-->

</div> <!-- container !-->
</main>
<% include ../partials/bottom %>
